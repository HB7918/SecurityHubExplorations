{"version":3,"file":"styles-check.js","sourceRoot":"","sources":["../../../../../src/internal/hooks/use-base-component/styles-check.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nimport React, { useEffect } from 'react';\n\nimport { GIT_SHA, PACKAGE_VERSION, THEME } from '../../environment';\nimport { metrics } from '../../metrics';\n\nfunction checkMissingStyles(ownerDocument: Document) {\n  if (!ownerDocument.defaultView) {\n    // skip the check if this iframe is detached\n    return;\n  }\n\n  const result = getComputedStyle(ownerDocument.body).getPropertyValue(`--awsui-version-info-${GIT_SHA}`);\n  if (!result) {\n    console.error(`Missing AWS-UI CSS for theme \"${THEME}\", version \"${PACKAGE_VERSION}\", and git sha \"${GIT_SHA}\".`);\n    metrics.sendOpsMetricObject('awsui-missing-css-asset', {});\n  }\n}\n\nfunction documentReady(document: Document, callback: () => void) {\n  if (document.readyState === 'complete') {\n    callback();\n  } else {\n    document.defaultView?.addEventListener('load', () => callback(), { once: true });\n  }\n}\n\nasync function documentReadyAndIdle(document: Document, signal: AbortSignal) {\n  await new Promise<void>((resolve, reject) => {\n    signal.addEventListener('abort', () => reject(new DOMException('Aborted', 'AbortError')));\n    documentReady(document, () => {\n      setTimeout(() => requestIdleCallback(() => resolve()), 1000);\n    });\n  });\n\n  const stylesheets = Array.from(document.querySelectorAll<HTMLLinkElement>('link[rel=\"stylesheet\"]'));\n  await Promise.all(\n    stylesheets.map(link => {\n      // already loaded\n      if (link.sheet) {\n        return Promise.resolve();\n      }\n      return new Promise<void>((resolve, reject) => {\n        function cleanup(done: () => void) {\n          link.removeEventListener('load', onLoad);\n          link.removeEventListener('error', onError);\n          signal.removeEventListener('abort', onAbort);\n          done();\n        }\n        const onLoad = () => cleanup(resolve);\n        const onError = () => cleanup(resolve);\n        const onAbort = () => cleanup(() => reject(new DOMException('Aborted', 'AbortError')));\n\n        link.addEventListener('load', onLoad);\n        link.addEventListener('error', onError);\n        signal.addEventListener('abort', onAbort);\n      });\n    })\n  );\n}\n\nlet checkedDocs = new WeakMap<Document, boolean>();\nconst checkMissingStylesOnce = (document: Document) => {\n  const checked = checkedDocs.get(document);\n  if (!checked) {\n    checkMissingStyles(document);\n    checkedDocs.set(document, true);\n  }\n};\n\nexport const __testResetCheckedDocs = () => (checkedDocs = new WeakMap());\n\nexport function useMissingStylesCheck(elementRef: React.RefObject<HTMLElement>) {\n  useEffect(() => {\n    // if idle callbacks not supported, we simply do not collect the metric\n    if (typeof requestIdleCallback !== 'function') {\n      return;\n    }\n    const ownerDocument = elementRef.current?.ownerDocument ?? document;\n    const abortController = new AbortController();\n    documentReadyAndIdle(ownerDocument, abortController.signal).then(\n      () => checkMissingStylesOnce(ownerDocument),\n      error => {\n        // istanbul ignore next\n        if (error.name !== 'AbortError') {\n          throw error;\n        }\n      }\n    );\n    return () => abortController.abort();\n  }, [elementRef]);\n}\n"]}